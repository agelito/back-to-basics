
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>6. Three Dimensions - Back to Basics</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#three-dimensions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Back to Basics" class="md-header__button md-logo" aria-label="Back to Basics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Back to Basics
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              6. Three Dimensions
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/agelito/back-to-basics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Back to Basics" class="md-nav__button md-logo" aria-label="Back to Basics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Back to Basics
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agelito/back-to-basics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1_hello_world/" class="md-nav__link">
        1. Hello World
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2_build_system/" class="md-nav__link">
        2. Build System
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3_creating_a_window/" class="md-nav__link">
        3. Creating a Window
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4_manipulating_pixels/" class="md-nav__link">
        4. Manipulating Pixels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5_hello_triangle/" class="md-nav__link">
        5. Hello Triangle
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          6. Three Dimensions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        6. Three Dimensions
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#math-functions" class="md-nav__link">
    Math Functions
  </a>
  
    <nav class="md-nav" aria-label="Math Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-operations" class="md-nav__link">
    Vector Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matrix-operations" class="md-nav__link">
    Matrix Operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transforming-vertices" class="md-nav__link">
    Transforming Vertices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#render-rotating-triangle-in-3d" class="md-nav__link">
    Render rotating triangle in 3D
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-diff-for-this-chapter" class="md-nav__link">
    Full diff for this chapter
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#math-functions" class="md-nav__link">
    Math Functions
  </a>
  
    <nav class="md-nav" aria-label="Math Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-operations" class="md-nav__link">
    Vector Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matrix-operations" class="md-nav__link">
    Matrix Operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transforming-vertices" class="md-nav__link">
    Transforming Vertices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#render-rotating-triangle-in-3d" class="md-nav__link">
    Render rotating triangle in 3D
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-diff-for-this-chapter" class="md-nav__link">
    Full diff for this chapter
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

                


<h1 id="three-dimensions">Three Dimensions</h1>
<p>Until now we've defined the triangle in screen space, and there's been no concept of depth or perspective. Now it's time to move to defining our triangle in world space and projecting it to the screen, accounting for perpective and depth.</p>
<h2 id="math-functions">Math Functions</h2>
<p>To project the triangle coordinates we'll have to add some functions for matrix and vector operations. In a previous chapter we created <code>math_utils.h</code> with some macros to help calculate the minimum and maximum values. We'll rename and extend that file to be just <code>math.h</code>. </p>
<p>Start by renaming the <code>math_utils.h</code> file to <code>math.h</code>, including updating the include paths and header guards for consistency.</p>
<pre><code class="language-sh">mv src/math_utils.h src/math.h
</code></pre>
<p>After renaming the file and updating the file to reflect the name change it should look like this:</p>
<pre><code class="language-c">// math.h

#ifndef MATH_INCLUDED
#define MATH_INCLUDED

#include &lt;math.h&gt;

#define Min(x, y) (x &lt; y ? x : y)
#define Min3(x, y, z) Min(x, Min(y, z))

#define Max(x, y) (x &gt; y ? x : y)
#define Max3(x, y, z) Max(x, Max(y, z))

// NOTE: Add the additional code here.

#endif // MATH_INCLUDED

</code></pre>
<h3 id="vector-operations">Vector Operations</h3>
<p>Now add the definitions for the <code>Vector3</code> and <code>Vector4</code> types to <code>src/math.h</code>:</p>
<pre><code class="language-c">typedef struct Vector3
{
    union
    {
        float xyz[3];
        struct {
            float x;
            float y;
            float z;
        };
    };
} Vector3;

typedef struct Vector4
{
    union
    {
        float xyzw[4];
        struct {
            float x;
            float y;
            float z;
            float w;
        };
    };
} Vector4;
</code></pre>
<p>Now add the functions we'll need to use doing calculations with the vectors to <code>src/math.h</code>. These functions will help us multiply, add, subtract, or get the inner and outer products of vectors.</p>
<pre><code class="language-c">static inline Vector3
vector3_create(float x, float y, float z)
{
    Vector3 result = {
        x, y, z
    };

    return result;
}

static inline Vector3
vector3_subtract(Vector3 a, Vector3 b)
{
    Vector3 result;
    result.x = a.x - b.x;
    result.y = a.y - b.y;
    result.z = a.z - b.z;

    return result;
}

static inline float
vector3_length(Vector3 a)
{
    return sqrt(a.x * a.x + a.y * a.y + a.z * a.z);
}

static inline Vector3
vector3_normalize(Vector3 a)
{
    float length = vector3_length(a);
    if (length &lt;= 0.0f)
    {
        return vector3_create(0.0f, 0.0f, 1.0f);
    }

    Vector3 result = vector3_create(a.x / length, a.y / length, a.z / length);

    return result;
}

static inline Vector3
vector3_cross(Vector3 a, Vector3 b)
{
    float x = a.y * b.z - a.z * b.y;
    float y = a.z * b.x - a.x * b.z;
    float z = a.x * b.y - a.y * b.x;
    return vector3_create(x, y, z);
}

static inline float
vector3_dot(Vector3 a, Vector3 b)
{
    return a.x * b.x + a.y * b.y + a.z * b.z;
}

static inline Vector3
vector4_mul(Vector4 a, Vector3 b)
{
    Vector3 result;
    result.x = a.x * b.x;
    result.y = a.y * b.y;
    result.z = a.z * b.z;
    return result;
}
</code></pre>
<h3 id="matrix-operations">Matrix Operations</h3>
<p>Moving on we'll also have to add the <code>Matrix4</code> struct and functions to create matrices. The matrix is very important and will be used to project our triangle vertices to the screen.</p>
<p>Add the struct definition for <code>Matrix4</code> to <code>src/math.h</code>:</p>
<pre><code class="language-c">typedef struct Matrix4
{
    union {
        struct {
            float x1; float y1; float z1; float w1;
            float x2; float y2; float z2; float w2;
            float x3; float y3; float z3; float w3;
            float x4; float y4; float z4; float w4;
        };
        float m[16];
    };
} Matrix4;
</code></pre>
<p>We'll need to create matrices for transforming vertices add these functions which will create matrices allowing us to define the orientation of our triangle in the 'world', Also where our point of view is, and approximating a pinhole camera lens to give some perspective.</p>
<p>Add these functions to <code>src/math.h</code>:</p>
<pre><code class="language-c">
// matrix4_lookat_lh will be used to define a &quot;camera&quot; in our scene. The `eye` parameter defines where the camera is. The `at` parameter defines where the camera is facing towards and the `up` parameter defines which direction is up. Up is usually (0.0, 1.0, 0.0).
static inline Matrix4
matrix4_lookat_lh(Vector3 eye, Vector3 at, Vector3 up)
{
    Vector3 z = vector3_normalize(vector3_subtract(at, eye));
    Vector3 x = vector3_normalize(vector3_cross(up, z));
    Vector3 y = vector3_cross(z, x);

    float eye_x = vector3_dot(x, eye);
    float eye_y = vector3_dot(y, eye);
    float eye_z = vector3_dot(z, eye);

    Matrix4 result = {
        x.x, x.y, x.z, 0.0f,
        y.x, y.y, y.z, 0.0f,
        z.x, z.y, z.z, 0.0f,
        -eye_x, -eye_y, -eye_z, 1.0f
    };

    return result;
}

// matrix4_perspective_lh will be used to approximate a pinhole camera perspective. This allow us defining the field-of-view as well as aspect ratio and near/far planes.
static inline Matrix4
matrix4_perspective_lh(float fov, float aspect_ratio, float z_near, float z_far)
{
    float degrees_to_radius = M_PI / 180.0f;
    float height = 1.0f / tanf(degrees_to_radius * fov / 2.0f);
    float width = height / aspect_ratio;

    float far_near = z_far - z_near;

    Matrix4 result = {
        width, 0.0f, 0.0f, 0.0f,
        0.0f, height, 0.0f, 0.0f,
        0.0f, 0.0f, z_far / far_near, 1.0f,
        0.0f, 0.0f, -z_near * z_far / far_near, 0.0f};

    return result;
}

// matrix4_rotate_[x,y,z] functions will create a matrix which rotates around any of the three major axis.
static inline Matrix4
matrix4_rotate_x(float rotation)
{
    float rot_sin = sinf(rotation);
    float rot_cos = cosf(rotation);

    Matrix4 result = {
        1.0f, 0.0f, 0.0f, 0.0f,
        0.0f, rot_cos, -rot_sin, 0.0f,
        0.0f, rot_sin, rot_cos, 0.0f,
        0.0f, 0.0f, 0.0f, 1.0f
    };

    return result;
}

static inline Matrix4
matrix4_rotate_y(float rotation)
{
    float rot_sin = sinf(rotation);
    float rot_cos = cosf(rotation);

    Matrix4 result = {
        rot_cos, 0.0f, rot_sin, 0.0f,
        0.0f, 1.0f, 0.0f, 0.0f,
        -rot_sin, 0.0f, rot_cos, 0.0f,
        0.0f, 0.0f, 0.0f, 1.0f};

    return result;
}

static inline Matrix4
matrix4_rotate_z(float rotation)
{
    float rot_sin = sinf(rotation);
    float rot_cos = cosf(rotation);

    Matrix4 result = {
        rot_cos, -rot_sin, 0.0f, 0.0f,
        rot_sin, rot_cos, 0.0f, 0.0f,
        0.0f, 0.0f, 1.0f, 0.0f,
        0.0f, 0.0f, 0.0f, 1.0f};

    return result;
}
</code></pre>
<p>Finally we'll also have to add function to multiply matrices with other matrices or vectors. This is essentially the same operation but since we don't have any generic function to multiply NxM vectors they will work with the specific types we already have defined. Add the following to <code>src/math.h</code>:</p>
<pre><code class="language-c">static inline Matrix4 
matrix4_multiply(Matrix4 a, Matrix4 b)
{
    Matrix4 result = {0.0f, 0.0f, 0.0f, 0.0f,
                      0.0f, 0.0f, 0.0f, 0.0f,
                      0.0f, 0.0f, 0.0f, 0.0f,
                      0.0f, 0.0f, 0.0f, 0.0f};

    int i,j,k;
    for (i = 0; i &lt; 4; i++)
    {
        for (j = 0; j &lt; 4; j++)
        {
            for (k = 0; k &lt; 4; k++)
            {
                result.m[j+i*4] += a.m[k+i*4]*b.m[j+k*4];
            }
        }
    }
    return result;
}

static inline Vector4
matrix4_multiply_vector3(Matrix4 m, Vector3 v)
{
    float x = v.x, y = v.y, z = v.z;
    Vector4 result = {(x*m.x1 + y * m.x2 + z * m.x3 + m.x4),
                      (x*m.y1 + y * m.y2 + z * m.y3 + m.y4),
                      (x*m.z1 + y * m.z2 + z * m.z3 + m.z4),
                      (x*m.w1 + y * m.w2 + z * m.w3 + m.w4)};
    return result;
}
</code></pre>
<p>This concludes all the math functions we'll be requiring for now.</p>
<h2 id="transforming-vertices">Transforming Vertices</h2>
<p>To transform the vertices we'll another file <code>src/vertex_transform.c</code> and the associated <code>src/vertex_transform.h</code>. Since the functions will be doing possibly a lot of math operations on very similar data they're written to allow passing in arrays of data instead of transforming data one by one. Doing this will help improve memory and cache performance.</p>
<pre><code class="language-sh">touch src/vertex_transform.h
touch src/vertex_transform.c
</code></pre>
<p>Populate the files with their content:</p>
<p><code>vertex_transform.h</code></p>
<pre><code class="language-c">// vertex_transform.h

#ifndef VERTEX_TRANSFORM_H
#define VERTEX_TRANSFORM_H

#include &quot;math.h&quot;

void
vertex_transform_positions(Matrix4 transform, Vector3* positions, Vector3* transformed_positions, int count);

void
vertex_transform_map_to_viewport(int width, int height, Vector3 *positions, Vector3 *mapped_positions, int count);

#endif // VERTEX_TRANSFORM_H
</code></pre>
<p><code>vertex_transform.c</code></p>
<pre><code class="language-c">// vertex_transform.c

#include &quot;vertex_transform.h&quot;

void
vertex_transform_positions(Matrix4 transform, Vector3 *positions, Vector3 *transformed_positions, int count)
{
    for (int i = 0; i &lt; count; ++i)
    {
        Vector3 position = *(positions + i);
        Vector4 transformed = matrix4_multiply_vector3(transform, position);

        Vector3 result = {
            transformed.x / transformed.w,
            transformed.y / transformed.w,
            transformed.z / transformed.w,
        };

        *(transformed_positions + i) = result;
    }
}

void
vertex_transform_map_to_viewport(int width, int height, Vector3 *positions, Vector3 *mapped_positions, int count)
{
    for (int i = 0; i &lt; count; ++i)
    {
        Vector3 position = *(positions + i);
        Vector3 result = {
            (0.5f + position.x * 0.5f) * width,
            (1.0f - (0.5f + position.y * 0.5f)) * height,
            (0.5f + position.z * 0.5f)
        };

        *(mapped_positions + i) = result;
    }
}
</code></pre>
<p>Add the <code>src/vertex_transform.c</code> to our <code>CMakeLists.txt</code> file, additionally we also link against the standard C math library by adding <code>m</code> to the <code>target_link_libraries</code> list:</p>
<pre><code class="language-cmake">add_executable(back_to_basics src/main.c src/game_window.c src/renderer.c src/vertex_transform.c)
target_link_libraries(back_to_basics ${SDL2_LIBRARIES} m)
</code></pre>
<h2 id="render-rotating-triangle-in-3d">Render rotating triangle in 3D</h2>
<p>To tie everything together we'll have to make some changes to <code>src/main.c</code> and also update the <code>math.h</code> include inside <code>src/renderer.c</code>. This is the last step before we can see some new results on the screen.</p>
<p>Update the <code>math.h</code> include in <code>src/renderer.c</code>:</p>
<pre><code class="language-c">#include &quot;math.h&quot;
</code></pre>
<p>We'll also add a convenience function to <code>src/renderer.h</code> for defining XY coordinates add the following below the RendererPoint struct definition:</p>
<pre><code class="language-c">static inline RendererPoint
renderer_point_create(int32_t x, int32_t y)
{
    RendererPoint result = {
        x, y};

    return result;
}
</code></pre>
<p>Add required includes to <code>src/main.c</code>:</p>
<pre><code class="language-c">#include &quot;vertex_transform.h&quot;
</code></pre>
<p>After creating the <code>GameWindow</code> add the following variable to store the triangle rotation in <code>src/main.c</code>:</p>
<pre><code class="language-c">GameWindow* game_window = game_window_create(&quot;back_to_basics&quot;, 680, 480);

float rotation = 0.0f;
</code></pre>
<p>Add the code creating and multiplying the matrices used for transforming triangle to <code>src/main.c</code> we're rendering two triangles, one for each side:</p>
<pre><code class="language-c">float aspect_ratio = (float)pixel_buffer.width / pixel_buffer.height;
Matrix4 projection = matrix4_perspective_lh(
    45.0f, aspect_ratio, 0.01f, 100.0f);

Matrix4 view = matrix4_lookat_lh(
    vector3_create(0.0f, 0.0f, -6.0f),
    vector3_create(0.0f, 0.0f, 0.0f),
    vector3_create(0.0f, 1.0f, 0.0f));

Matrix4 model = matrix4_rotate_y(rotation);
rotation += 0.04f;

Matrix4 model_view = matrix4_multiply(model, view);
Matrix4 transform = matrix4_multiply(model_view, projection);

Vector3 positions[6] = {
    vector3_create(-1.0f, -1.0f, 0.0f),
    vector3_create(0.0f, 1.0f, 0.0f),
    vector3_create(1.0f, -1.0f, 0.0f),
    vector3_create(0.0f, 1.0f, 0.0f),
    vector3_create(-1.0f, -1.0f, 0.0f),
    vector3_create(1.0f, -1.0f, 0.0f)};
Vector3 transformed[6];

vertex_transform_positions(transform, positions, transformed, 6);
vertex_transform_map_to_viewport(
    pixel_buffer.width, pixel_buffer.height, transformed, positions, 6);

RendererTriangle triangle;
triangle.p0 = renderer_point_create((int32_t)positions[0].x, (int32_t)positions[0].y);
triangle.p1 = renderer_point_create((int32_t)positions[1].x, (int32_t)positions[1].y);
triangle.p2 = renderer_point_create((int32_t)positions[2].x, (int32_t)positions[2].y);

RendererTriangle triangle2;
triangle2.p0 = renderer_point_create((int32_t)positions[3].x, (int32_t)positions[3].y);
triangle2.p1 = renderer_point_create((int32_t)positions[4].x, (int32_t)positions[4].y);
triangle2.p2 = renderer_point_create((int32_t)positions[5].x, (int32_t)positions[5].y);

triangle.c0 = PackColorRGB(255, 0, 0);
triangle.c1 = PackColorRGB(0, 255, 0);
triangle.c2 = PackColorRGB(0, 0, 255);

triangle2.c0 = PackColorRGB(0, 255, 0);
triangle2.c1 = PackColorRGB(255, 0, 0);
triangle2.c2 = PackColorRGB(0, 0, 255);

renderer_fill_triangle(pixel_buffer, triangle);
renderer_fill_triangle(pixel_buffer, triangle2);
</code></pre>
<p>Now if we compile and run the program there should be a spinning triangle on the screen. The next steps will be to implement triangle sorting to ensure they're rendered in the correct order and also adding clipping and clampig to ensure we don't draw outside the viewport boundaries.</p>
<p><img alt="spinning triangle 1" src="../6_assets/spinning_triangle_1.png" />
<img alt="spinning triangle 2" src="../6_assets/spinning_triangle_2.png" /></p>
<h2 id="full-diff-for-this-chapter">Full diff for this chapter</h2>
<pre><code class="language-diff">diff --git a/CMakeLists.txt b/CMakeLists.txt
index ed4ae1c..9ac1e38 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -7,5 +7,5 @@ set(CMAKE_C_STANDARD 11)
 find_package(SDL2 REQUIRED)
 include_directories(back_to_basics ${SDL2_INCLUDE_DIRS})

-add_executable(back_to_basics src/main.c src/game_window.c src/renderer.c)
-target_link_libraries(back_to_basics ${SDL2_LIBRARIES})
+add_executable(back_to_basics src/main.c src/game_window.c src/renderer.c src/vertex_transform.c)
+target_link_libraries(back_to_basics ${SDL2_LIBRARIES} m)
diff --git a/src/main.c b/src/main.c
index 3f124c9..6aadd9a 100644
--- a/src/main.c
+++ b/src/main.c
@@ -4,6 +4,7 @@

 #include &quot;game_window.h&quot;
 #include &quot;renderer.h&quot;
+#include &quot;vertex_transform.h&quot;

 int main(int argc, char* argv[])
 {
@@ -16,6 +17,8 @@ int main(int argc, char* argv[])
     GameWindow* game_window = 
         game_window_create(&quot;back_to_basics&quot;, 680, 480);

+    float rotation = 0.0f;
+
     while ((game_window-&gt;flags &amp; GAME_WINDOW_FLAGS_CLOSED) == 0)
     {
         game_window_process_events(game_window);
@@ -56,20 +59,54 @@ int main(int argc, char* argv[])
             renderer_fill_rect(pixel_buffer, bottom_left, PackColorRGB(0, 255, 255));
             renderer_fill_rect(pixel_buffer, bottom_right, PackColorRGB(255, 255, 0));

-            RendererPoint center = { 
-                pixel_buffer.width / 2,
-                pixel_buffer.height / 2
-            };
-            RendererTriangle center_triangle = {
-                {center.x, center.y - 128},
-                {center.x + 128, center.y + 128}, 
-                {center.x - 128, center.y + 128},
-                PackColorRGB(255, 0, 0),
-                PackColorRGB(0, 255, 0),
-                PackColorRGB(0, 0, 255)
-            };
-
-            renderer_fill_triangle(pixel_buffer, center_triangle);
+            float aspect_ratio = (float)pixel_buffer.width / pixel_buffer.height;
+            Matrix4 projection = matrix4_perspective_lh(
+                45.0f, aspect_ratio, 0.01f, 100.0f);
+
+            Matrix4 view = matrix4_lookat_lh(
+                vector3_create(0.0f, 0.0f, -6.0f),
+                vector3_create(0.0f, 0.0f, 0.0f),
+                vector3_create(0.0f, 1.0f, 0.0f));
+
+            Matrix4 model = matrix4_rotate_y(rotation);
+            rotation += 0.04f;
+
+            Matrix4 model_view = matrix4_multiply(model, view);
+            Matrix4 transform = matrix4_multiply(model_view, projection);
+
+            Vector3 positions[6] = {
+                vector3_create(-1.0f, -1.0f, 0.0f),
+                vector3_create(0.0f, 1.0f, 0.0f),
+                vector3_create(1.0f, -1.0f, 0.0f),
+                vector3_create(0.0f, 1.0f, 0.0f),
+                vector3_create(-1.0f, -1.0f, 0.0f),
+                vector3_create(1.0f, -1.0f, 0.0f)};
+            Vector3 transformed[6];
+
+            vertex_transform_positions(transform, positions, transformed, 6);
+            vertex_transform_map_to_viewport(
+                pixel_buffer.width, pixel_buffer.height, transformed, positions, 6);
+
+            RendererTriangle triangle;
+            triangle.p0 = renderer_point_create((int32_t)positions[0].x, (int32_t)positions[0].y);
+            triangle.p1 = renderer_point_create((int32_t)positions[1].x, (int32_t)positions[1].y);
+            triangle.p2 = renderer_point_create((int32_t)positions[2].x, (int32_t)positions[2].y);
+
+            RendererTriangle triangle2;
+            triangle2.p0 = renderer_point_create((int32_t)positions[3].x, (int32_t)positions[3].y);
+            triangle2.p1 = renderer_point_create((int32_t)positions[4].x, (int32_t)positions[4].y);
+            triangle2.p2 = renderer_point_create((int32_t)positions[5].x, (int32_t)positions[5].y);
+
+            triangle.c0 = PackColorRGB(255, 0, 0);
+            triangle.c1 = PackColorRGB(0, 255, 0);
+            triangle.c2 = PackColorRGB(0, 0, 255);
+
+            triangle2.c0 = PackColorRGB(0, 255, 0);
+            triangle2.c1 = PackColorRGB(255, 0, 0);
+            triangle2.c2 = PackColorRGB(0, 0, 255);
+
+            renderer_fill_triangle(pixel_buffer, triangle);
+            renderer_fill_triangle(pixel_buffer, triangle2);
         }

         game_window_surface_unlock_and_update_pixels(game_window);
diff --git a/src/math.h b/src/math.h
new file mode 100644
index 0000000..4e374e8
--- /dev/null
+++ b/src/math.h
@@ -0,0 +1,238 @@
+// math.h
+
+#ifndef MATH_INCLUDED
+#define MATH_INCLUDED
+
+#include &lt;math.h&gt;
+
+#define Min(x, y) (x &lt; y ? x : y)
+#define Min3(x, y, z) Min(x, Min(y, z))
+
+#define Max(x, y) (x &gt; y ? x : y)
+#define Max3(x, y, z) Max(x, Max(y, z))
+
+typedef struct Vector3
+{
+    union
+    {
+        float xyz[3];
+        struct {
+            float x;
+            float y;
+            float z;
+        };
+    };
+} Vector3;
+
+typedef struct Vector4
+{
+    union
+    {
+        float xyzw[4];
+        struct {
+            float x;
+            float y;
+            float z;
+            float w;
+        };
+    };
+} Vector4;
+
+static inline Vector3
+vector3_create(float x, float y, float z)
+{
+    Vector3 result = {
+        x, y, z
+    };
+
+    return result;
+}
+
+static inline Vector3
+vector3_subtract(Vector3 a, Vector3 b)
+{
+    Vector3 result;
+    result.x = a.x - b.x;
+    result.y = a.y - b.y;
+    result.z = a.z - b.z;
+
+    return result;
+}
+
+static inline float
+vector3_length(Vector3 a)
+{
+    return sqrt(a.x * a.x + a.y * a.y + a.z * a.z);
+}
+
+static inline Vector3
+vector3_normalize(Vector3 a)
+{
+    float length = vector3_length(a);
+    if (length &lt;= 0.0f)
+    {
+        return vector3_create(0.0f, 0.0f, 1.0f);
+    }
+
+    Vector3 result = vector3_create(a.x / length, a.y / length, a.z / length);
+
+    return result;
+}
+
+static inline Vector3
+vector3_cross(Vector3 a, Vector3 b)
+{
+    float x = a.y * b.z - a.z * b.y;
+    float y = a.z * b.x - a.x * b.z;
+    float z = a.x * b.y - a.y * b.x;
+    return vector3_create(x, y, z);
+}
+
+static inline float
+vector3_dot(Vector3 a, Vector3 b)
+{
+    return a.x * b.x + a.y * b.y + a.z * b.z;
+}
+
+static inline Vector3
+vector4_mul(Vector4 a, Vector3 b)
+{
+    Vector3 result;
+    result.x = a.x * b.x;
+    result.y = a.y * b.y;
+    result.z = a.z * b.z;
+    return result;
+}
+
+typedef struct Matrix4
+{
+    union {
+        struct {
+            float x1; float y1; float z1; float w1;
+            float x2; float y2; float z2; float w2;
+            float x3; float y3; float z3; float w3;
+            float x4; float y4; float z4; float w4;
+        };
+        float m[16];
+    };
+} Matrix4;
+
+static inline Matrix4
+matrix4_lookat_lh(Vector3 eye, Vector3 at, Vector3 up)
+{
+    Vector3 z = vector3_normalize(vector3_subtract(at, eye));
+    Vector3 x = vector3_normalize(vector3_cross(up, z));
+    Vector3 y = vector3_cross(z, x);
+
+    float eye_x = vector3_dot(x, eye);
+    float eye_y = vector3_dot(y, eye);
+    float eye_z = vector3_dot(z, eye);
+
+    Matrix4 result = {
+        x.x, x.y, x.z, 0.0f,
+        y.x, y.y, y.z, 0.0f,
+        z.x, z.y, z.z, 0.0f,
+        -eye_x, -eye_y, -eye_z, 1.0f
+    };
+
+    return result;
+}
+
+static inline Matrix4
+matrix4_perspective_lh(float fov, float aspect_ratio, float z_near, float z_far)
+{
+    float degrees_to_radius = M_PI / 180.0f;
+    float height = 1.0f / tanf(degrees_to_radius * fov / 2.0f);
+    float width = height / aspect_ratio;
+
+    float far_near = z_far - z_near;
+
+    Matrix4 result = {
+        width, 0.0f, 0.0f, 0.0f,
+        0.0f, height, 0.0f, 0.0f,
+        0.0f, 0.0f, z_far / far_near, 1.0f,
+        0.0f, 0.0f, -z_near * z_far / far_near, 0.0f};
+
+    return result;
+}
+
+static inline Matrix4
+matrix4_rotate_x(float rotation)
+{
+    float rot_sin = sinf(rotation);
+    float rot_cos = cosf(rotation);
+
+    Matrix4 result = {
+        1.0f, 0.0f, 0.0f, 0.0f,
+        0.0f, rot_cos, -rot_sin, 0.0f,
+        0.0f, rot_sin, rot_cos, 0.0f,
+        0.0f, 0.0f, 0.0f, 1.0f
+    };
+
+    return result;
+}
+
+static inline Matrix4
+matrix4_rotate_y(float rotation)
+{
+    float rot_sin = sinf(rotation);
+    float rot_cos = cosf(rotation);
+
+    Matrix4 result = {
+        rot_cos, 0.0f, rot_sin, 0.0f,
+        0.0f, 1.0f, 0.0f, 0.0f,
+        -rot_sin, 0.0f, rot_cos, 0.0f,
+        0.0f, 0.0f, 0.0f, 1.0f};
+
+    return result;
+}
+
+static inline Matrix4
+matrix4_rotate_z(float rotation)
+{
+    float rot_sin = sinf(rotation);
+    float rot_cos = cosf(rotation);
+
+    Matrix4 result = {
+        rot_cos, -rot_sin, 0.0f, 0.0f,
+        rot_sin, rot_cos, 0.0f, 0.0f,
+        0.0f, 0.0f, 1.0f, 0.0f,
+        0.0f, 0.0f, 0.0f, 1.0f};
+
+    return result;
+}
+
+static inline Matrix4 
+matrix4_multiply(Matrix4 a, Matrix4 b)
+{
+    Matrix4 result = {0.0f, 0.0f, 0.0f, 0.0f,
+                      0.0f, 0.0f, 0.0f, 0.0f,
+                      0.0f, 0.0f, 0.0f, 0.0f,
+                      0.0f, 0.0f, 0.0f, 0.0f};
+
+    int i,j,k;
+    for (i = 0; i &lt; 4; i++)
+    {
+        for (j = 0; j &lt; 4; j++)
+        {
+            for (k = 0; k &lt; 4; k++)
+            {
+                result.m[j+i*4] += a.m[k+i*4]*b.m[j+k*4];
+            }
+        }
+    }
+    return result;
+}
+
+static inline Vector4
+matrix4_multiply_vector3(Matrix4 m, Vector3 v)
+{
+    float x = v.x, y = v.y, z = v.z;
+    Vector4 result = {(x*m.x1 + y * m.x2 + z * m.x3 + m.x4),
+                      (x*m.y1 + y * m.y2 + z * m.y3 + m.y4),
+                      (x*m.z1 + y * m.z2 + z * m.z3 + m.z4),
+                      (x*m.w1 + y * m.w2 + z * m.w3 + m.w4)};
+    return result;
+}
+
+#endif // MATH_INCLUDED
\ No newline at end of file
diff --git a/src/math_utils.h b/src/math_utils.h
deleted file mode 100644
index 7cac0fa..0000000
--- a/src/math_utils.h
+++ /dev/null
@@ -1,12 +0,0 @@
-// math_utils.h
-
-#ifndef MATH_UTILS_INCLUDED
-#define MATH_UTILS_INCLUDED
-
-#define Min(x, y) (x &lt; y ? x : y)
-#define Min3(x, y, z) Min(x, Min(y, z))
-
-#define Max(x, y) (x &gt; y ? x : y)
-#define Max3(x, y, z) Max(x, Max(y, z))
-
-#endif // MATH_UTILS_INCLUDED
\ No newline at end of file
diff --git a/src/renderer.c b/src/renderer.c
index a5362ae..5aa0204 100644
--- a/src/renderer.c
+++ b/src/renderer.c
@@ -2,7 +2,7 @@

 #include &lt;stdint.h&gt;
 #include &quot;renderer.h&quot;
-#include &quot;math_utils.h&quot;
+#include &quot;math.h&quot;

 static inline int32_t 
 signed_area2(RendererPoint p0, RendererPoint p1, RendererPoint p2)
diff --git a/src/renderer.h b/src/renderer.h
index 2c7f3e7..eae49ec 100644
--- a/src/renderer.h
+++ b/src/renderer.h
@@ -22,6 +22,15 @@ typedef struct RendererPoint {
     int32_t y;
 } RendererPoint;

+static inline RendererPoint
+renderer_point_create(int32_t x, int32_t y)
+{
+    RendererPoint result = {
+        x, y};
+
+    return result;
+}
+
 typedef struct RendererTriangle {
     RendererPoint p0;
     RendererPoint p1;
@@ -61,4 +70,4 @@ renderer_fill_rect(RendererTargetBuffer buffer, RendererRect rect, uint32_t colo
 void 
 renderer_fill_triangle(RendererTargetBuffer buffer, RendererTriangle triangle);

-#endif // RENDERER_INCLUDED
\ No newline at end of file
+#endif // RENDERER_INCLUDED
diff --git a/src/vertex_transform.c b/src/vertex_transform.c
new file mode 100644
index 0000000..2226d94
--- /dev/null
+++ b/src/vertex_transform.c
@@ -0,0 +1,37 @@
+// vertex_transform.c
+
+#include &quot;vertex_transform.h&quot;
+
+void
+vertex_transform_positions(Matrix4 transform, Vector3 *positions, Vector3 *transformed_positions, int count)
+{
+    for (int i = 0; i &lt; count; ++i)
+    {
+        Vector3 position = *(positions + i);
+        Vector4 transformed = matrix4_multiply_vector3(transform, position);
+
+        Vector3 result = {
+            transformed.x / transformed.w,
+            transformed.y / transformed.w,
+            transformed.z / transformed.w,
+        };
+
+        *(transformed_positions + i) = result;
+    }
+}
+
+void
+vertex_transform_map_to_viewport(int width, int height, Vector3 *positions, Vector3 *mapped_positions, int count)
+{
+    for (int i = 0; i &lt; count; ++i)
+    {
+        Vector3 position = *(positions + i);
+        Vector3 result = {
+            (0.5f + position.x * 0.5f) * width,
+            (1.0f - (0.5f + position.y * 0.5f)) * height,
+            (0.5f + position.z * 0.5f)
+        };
+
+        *(mapped_positions + i) = result;
+    }
+}
\ No newline at end of file
diff --git a/src/vertex_transform.h b/src/vertex_transform.h
new file mode 100644
index 0000000..ee62a43
--- /dev/null
+++ b/src/vertex_transform.h
@@ -0,0 +1,14 @@
+// vertex_transform.h
+
+#ifndef VERTEX_TRANSFORM_H
+#define VERTEX_TRANSFORM_H
+
+#include &quot;math.h&quot;
+
+void
+vertex_transform_positions(Matrix4 transform, Vector3* positions, Vector3* transformed_positions, int count);
+
+void
+vertex_transform_map_to_viewport(int width, int height, Vector3 *positions, Vector3 *mapped_positions, int count);
+
+#endif // VERTEX_TRANSFORM_H
\ No newline at end of file
</code></pre>




              

<!-- Giscus -->
<h2 id="__comments">Comments</h2>
<script src="https://giscus.app/client.js" data-repo="agelito/back-to-basics-discussions" data-repo-id="R_kgDOH8Q8Dw"
    data-category="Announcements" data-category-id="DIC_kwDOH8Q8D84CRPhD" data-mapping="pathname" data-strict="0"
    data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en"
    crossorigin="anonymous" async>
    </script>

<!-- Synchronize Giscus theme with palette -->
<script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"
        giscus.setAttribute("data-theme", theme)
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function () {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function () {
            var palette = __md_get("__palette")
            if (palette && typeof palette.color === "object") {
                var theme = palette.color.scheme === "slate" ? "dark" : "light"

                /* Instruct Giscus to change theme */
                var frame = document.querySelector(".giscus-frame")
                frame.contentWindow.postMessage(
                    { giscus: { setConfig: { theme } } },
                    "https://giscus.app"
                )
            }
        })
    })
</script>

            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../5_hello_triangle/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 5. Hello Triangle" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              5. Hello Triangle
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>